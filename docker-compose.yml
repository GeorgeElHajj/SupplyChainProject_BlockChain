version: '3.8'

services:
  # ==================== BLOCKCHAIN NODES ====================

  blockchain1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: blockchain_node_1
    hostname: blockchain1
    ports:
      - "5000:5000"
    volumes:
      - blockchain1_data:/data
      - ./keys:/app/keys:rw
    environment:
      - PORT=5000
      - DIFFICULTY=2
    command: ["--port", "5000", "--hostname", "blockchain1", "--difficulty", "2"]
    networks:
      - supply_chain_network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/status', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  blockchain2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: blockchain_node_2
    hostname: blockchain2
    ports:
      - "5001:5000"
    volumes:
      - blockchain2_data:/data
      - ./keys:/app/keys:rw
    environment:
      - PORT=5000
      - DIFFICULTY=2
    command: ["--port", "5000", "--hostname", "blockchain2", "--difficulty", "2", "--bootstrap", "http://blockchain1:5000", "--no-auto-mine"]
    networks:
      - supply_chain_network
    depends_on:
      - blockchain1
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/status', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  blockchain3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: blockchain_node_3
    hostname: blockchain3
    ports:
      - "5002:5000"
    volumes:
      - blockchain3_data:/data
      - ./keys:/app/keys:rw
    environment:
      - PORT=5000
      - DIFFICULTY=2
    command: ["--port", "5000", "--hostname", "blockchain3", "--difficulty", "2", "--bootstrap", "http://blockchain1:5000,http://blockchain2:5000", "--no-auto-mine"]
    networks:
      - supply_chain_network
    depends_on:
      - blockchain1
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/status', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

    # ==================== API SERVICES ====================

  supplier-api:
    build:
      context: ../SupplierAPI/SupplierAPI
      dockerfile: Dockerfile
    container_name: supplier_api
    hostname: supplier-api
    ports:
      - "5175:80"
    volumes:
      - ./keys:/app/keys:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Blockchain__NodeUrl=http://blockchain1:5000
      - Blockchain__TimeoutSeconds=30
      - Blockchain__EnableCrypto=true
      - Blockchain__ActorName=Supplier_A
    networks:
      - supply_chain_network
    depends_on:
      - blockchain1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/supplier/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  distributor-api:
    build:
      context: ../DistributorAPI/DistributorAPI
      dockerfile: Dockerfile
    container_name: distributor_api
    hostname: distributor-api
    ports:
      - "5137:80"
    volumes:
      - ./keys:/app/keys:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Blockchain__NodeUrl=http://blockchain2:5000
      - Blockchain__TimeoutSeconds=30
      - Blockchain__EnableCrypto=true
      - Blockchain__ActorName=Distributor_B
    networks:
      - supply_chain_network
    depends_on:
      - blockchain2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/distributor/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  retailer-api:
    build:
      context: ../RetailerAPI/RetailerAPI
      dockerfile: Dockerfile
    container_name: retailer_api
    hostname: retailer-api
    ports:
      - "5112:80"
    volumes:
      - ./keys:/app/keys:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Blockchain__NodeUrl=http://blockchain3:5000
      - Blockchain__TimeoutSeconds=30
      - Blockchain__EnableCrypto=true
      - Blockchain__ActorName=Retailer_C
    networks:
      - supply_chain_network
    depends_on:
      - blockchain3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/retailer/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
# ==================== ADMIN API ====================

  admin-api:
    build:
      context: .
      dockerfile: Dockerfile.admin
    container_name: admin_api
    hostname: admin-api
    ports:
      - "5500:5500"
    volumes:
      - ./keys:/app/keys:rw
      - admin_data:/app/data
    environment:
      - FLASK_ENV=production
      - FLASK_APP=admin_api.py
    networks:
      - supply_chain_network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5500/admin/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ==================== REACT FRONTEND ====================

  frontend:
    build:
      context: ./supply-chain-ui
      dockerfile: Dockerfile
    container_name: supply_chain_frontend
    hostname: frontend
    ports:
      - "3010:80"
    environment:
      - REACT_APP_BLOCKCHAIN_API=http://localhost:5000
      - REACT_APP_ADMIN_API=http://localhost:5500
      - REACT_APP_SUPPLIER_API=http://localhost:5175
      - REACT_APP_DISTRIBUTOR_API=http://localhost:5137
      - REACT_APP_RETAILER_API=http://localhost:5112
    networks:
      - supply_chain_network
    depends_on:
      - blockchain1
      - blockchain2
      - blockchain3
      - admin-api
      - supplier-api
      - distributor-api
      - retailer-api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

# ==================== NETWORKS ====================

networks:
  supply_chain_network:
    driver: bridge

# ==================== VOLUMES ====================

volumes:
  blockchain1_data:
    driver: local
  blockchain2_data:
    driver: local
  blockchain3_data:
    driver: local
  admin_data:
    driver: local